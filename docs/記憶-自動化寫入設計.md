# 記憶 — 自動化寫入設計

> **目標：** 當對話變長、Token 累積到一定量（如 7K／1 萬／2 萬／3 萬）時，**自動**把討論重點寫入本地記憶，並精簡後續帶入的 context，以減少每次溝通的 Token 負擔，並避免內容已偏離主題（或穿插閒聊）時 Token 仍持續增加。

---

## 一、為什麼要做自動化寫入？

- **Token 會隨輪次成長：** 討論一件事時，每多一輪就多一段歷史，context 愈來愈大（7K → 1 萬 → 2 萬…）。
- **穿插閒聊：** 討論中可能穿插體操、問候、閒聊；若不做調節，這些也會一起佔 Token，且偏離主題時仍帶著整段歷史。
- **自動寫入可達成：**
  1. **減少負擔：** 把「已討論過的重點」寫進本地（MEMORY_FULL、memory/日期），之後只帶「摘要 + 最近幾輪」，不再每輪重送整段。
  2. **保留前文：** 寫入的內容就是「前上下文」；之後需要時用 memory_search 或讀取對應段落即可。
  3. **偏離時不膨脹：** 達到閾值就寫入並精簡，即使後面變成閒聊，也不會一直帶著幾萬 token 的舊討論。

---

## 二、觸發條件（何時自動寫入？）

建議以 **「預估 Token 數」** 或 **「輪數」** 為閾值，可設定一檔（例如 7,000、10,000、20,000、30,000 token），由 config 或環境決定：

| 閾值類型 | 範例 | 說明 |
|----------|------|------|
| **Token 估計** | 7,000 / 10,000 / 20,000 / 30,000 | 當「system + bootstrap + 對話歷史」預估超過該值即觸發 |
| **輪數** | 例如 10 輪、20 輪 | 當 user turn 數超過即觸發（實作簡單，可與 token 並用） |

- **建議預設：** 先以 10,000 或 20,000 token 為一檔，可設 `agents.defaults.autoWriteMemoryThreshold: 10000`（或 20000）。
- **觸發時機：** 在**本輪要送給模型之前**檢查；若超過閾值，先執行「摘要 → 寫入本地 → 精簡歷史」，再送本輪。

---

## 三、寫入什麼？—— 穿插（任務 vs 閒聊）的調節

討論與閒聊可能穿插出現，自動寫入時應**以「有記憶價值的內容」為主**，並可標註閒聊段落，避免無關內容佔滿記憶。

### 3.1 要寫入的（建議）

- **主題／任務相關：** 討論的主題、結論、決定、待辦、數字、人名、日期等。
- **結構：** 依時間或主題分點；每段可標日期（如 2026-02-08）。
- **若穿插閒聊：** 只摘要「任務／主題」部分；閒聊部分可寫一句「其間穿插閒聊（如體操、問候等）」即可，不逐字寫入。

### 3.2 寫到哪裡？

| 目標 | 用途 |
|------|------|
| **MEMORY_FULL.md** | 新增一區塊，例如 `## 對話摘要 (2026-02-08)`，把本次摘要寫入；長期可查 |
| **memory/YYYY-MM-DD.md** | 同日可追加一段「本段討論摘要：…」；方便「今天／昨天」查詢 |
| **MEMORY.md（索引）** | 若摘要裡出現新關鍵字，補上對應關鍵字（符合「有資料才設索引」） |

### 3.3 摘要格式範例

```markdown
## 對話摘要 (2026-02-08)

- **主題：** Fallback Bot 修復與任務板 API
- **重點：** 修正 pgrep 誤匹配；改用 curl API 再精確匹配。任務板用 scripts/task-board-api.sh。
- **待測：** 明天殺掉 gateway 測 fallback 接管。
- **其間穿插：** 閒聊體操、問候。
```

這樣「前上下文」被保留在本地，之後用記憶搜尋或讀檔即可；不需再整段放進 prompt。

---

## 四、寫入後的精簡（減少後續 Token）

寫入完成後，要讓**下一輪起**的 request 不再帶著整段歷史，只帶「精簡後的 context」。

### 4.1 做法一：只保留最近 N 輪 + 一句摘要（建議）

- **保留：** 最近 N 輪（例如 4～6 輪，user+assistant 成對）完整內容。
- **取代其餘：** 用**一句系統或虛擬 user 訊息**取代更早的歷史，例如：  
  「[先前討論已寫入記憶] 摘要：Fallback Bot 修復方式、任務板 API 路徑、明日待測。詳見 MEMORY_FULL § 對話摘要 (2026-02-08) 與 memory/2026-02-08.md。」
- **效果：** 之後每輪只帶「摘要一句 + 最近 N 輪」，Token 從 2 萬降回約數 K。

### 4.2 做法二：僅依現有 limitHistoryTurns 再縮小 N

- 若 OpenClaw 已有 `limitHistoryTurns`（只保留最近 N 個 user turn），可在觸發自動寫入後，把 N 改小（例如改為 3 或 4），讓歷史更短。
- 缺點：模型看不到「更早討論了什麼」，只能靠記憶檔；因此**建議搭配一句「已寫入記憶，摘要：…」** 放進 system 或第一則 user，讓模型知道前文在哪。

---

## 五、整體流程（簡述）

1. **每輪發送前檢查：** 當前 context（system + bootstrap + 對話歷史）預估 Token 是否 ≥ 閾值（如 10,000）。
2. **若未達：** 照常送本輪。
3. **若達標：**
   - **摘要：** 對目前對話歷史做摘要（以任務／主題為主；穿插閒聊可一筆帶過）。
   - **寫入本地：** 將摘要寫入 MEMORY_FULL.md（新區塊）+ memory/YYYY-MM-DD.md；若有新關鍵字則更新 MEMORY.md。
   - **精簡：** 將會話歷史改為「一句摘要（含指向 MEMORY 與日期檔）+ 最近 N 輪」。
   - **送本輪：** 用精簡後的 context 送本輪請求。

之後每一輪都只帶「摘要 + 最近 N 輪」，直到再次累積到閾值，再觸發一輪自動寫入。

---

## 六、實作方式建議

### 6.1 方案 A：Agent 端驅動（先做、不改 Gateway 核心）

- **在 system 注入目前 context 資訊：** 例如「目前對話約 X 輪，預估 Y token（或僅寫輪數）」；閾值寫在 AGENTS 或 MEMORY 說明裡（如 10,000 token 或 15 輪）。
- **Agent 指令：** 當發現「輪數或 token 已達閾值」時：
  1. 先**摘要**這段對話（以討論主題為主，閒聊一筆帶過），
  2. 用既有工具或 `edit`/`write` 寫入 MEMORY_FULL.md 與 memory/YYYY-MM-DD.md，
  3. 在回覆中註明「已將討論重點寫入記憶，之後將只保留最近幾輪；需要時可從 MEMORY 或 memory/日期 查詢」。
- **精簡由誰做：** 若 session 層有 `limitHistoryTurns`，可依 config 在「下一輪」自動用較小的 N；或由人／管理流程手動清一段歷史。Agent 無法自己刪 session 歷史，只能「寫入 + 提醒」。
- **優點：** 不需改 OpenClaw 程式，先驗證「寫入內容與格式」是否合用。  
- **缺點：** 精簡這一步若沒有 Gateway/session 支援，需靠現有 history limit 或手動；且 token 估計若不準，需用輪數代替。

### 6.2 方案 B：Gateway / Session 層驅動（完整自動）

- **發送前：** 計算當前 request 的預估 token（或輪數）；若 ≥ 閾值：
  1. 先不送本輪；
  2. 呼叫一輪「僅摘要」的請求（或內建摘要邏輯），產出摘要文字；
  3. 將摘要寫入 MEMORY_FULL + memory/日期（可透過現有寫檔機制或專用 API）；
  4. 對 session 做精簡：只保留「最近 N 輪」+ 在 system 或首則訊息插入「已寫入記憶，摘要：…」；
  5. 再送使用者的本輪訊息。
- **優點：** 觸發與精簡都自動，Token 控制精準。  
- **缺點：** 需在 OpenClaw 或 session 管理裡加「預檢查 → 摘要 → 寫檔 → 精簡」流程，並決定摘要用同一模型或輕量模型。

### 6.3 建議順序

1. **先做方案 A：** 在 AGENTS.md（或 MEMORY 寫入須知）加上「自動寫入」規則與閾值（輪數或 token 估計），讓 Agent 在達閾值時主動摘要並寫入 MEMORY_FULL + memory/日期；必要時在 config 提供 `dmHistoryLimit` 或類似，讓長對話自動只保留最近 N 輪。
2. **再考慮方案 B：** 若需要「完全自動、不依賴 Agent 判斷」，再在 Gateway/session 實作預檢查、摘要、寫檔、精簡一體化。

---

## 七、Config 與閾值建議（已接線）

- **輪數閾值（已實作）：** 每輪送給模型前，Gateway 會在 system prompt 末尾注入：  
  `[Session: 本對話約 N 個 user 回合。若 ≥X 且討論已告一段落，請依 AGENTS 自動化寫入規則摘要並寫入記憶。]`  
  N = 目前 user 回合數，X = config 或預設 15。
- **Config（可選）：** 在 `openclaw.json` 或對應 config 的 `agents.defaults` 下可設：
  - `autoWriteMemoryThresholdTurns`: 數字，預設 15；超過此輪數即提示 Agent 可觸發自動寫入。

若未來實作「依 token 觸發」或「寫入後自動精簡歷史」，可再加 `autoWriteMemoryThreshold`（token 數）、`autoWriteHistoryTurnsAfter`（精簡後保留幾輪）等。

---

## 八、小結

- **自動化寫入** = 當 Token（或輪數）達閾值 → 摘要討論重點（任務為主、閒聊一筆帶過）→ 寫入 MEMORY_FULL + memory/日期 → 精簡後續為「摘要一句 + 最近 N 輪」。
- **穿插調節** = 摘要時區分「主題／任務」與「閒聊」，只把有記憶價值的寫入，並可註記「其間穿插閒聊」。
- **前上下文** = 寫入的內容即為前文；之後用 memory_search 或讀取對應段落即可，不需再帶整段歷史。
- 實作可先 **Agent 驅動（寫入 + 提醒）**，再視需要做 **Gateway 驅動（自動精簡）**。
