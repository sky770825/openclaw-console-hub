# 任務執行中斷與沒有回應 — 排查說明

執行任務時**不確定會跑多久**，但**經常中途中斷、之後就沒有回應**，多半與逾時、連線或 session 長度有關。可依下列方向排查。

---

## 一、可能原因與對照

| 現象 | 可能原因 | 建議作法 |
|------|----------|----------|
| **跑一陣子就停、沒有錯誤訊息** | **Gateway 或工具逾時**：單次 RPC／工具呼叫超過預設時間被切斷 | 1) 看 Gateway／終端日誌是否有 `gateway timeout after Xms` 或工具 timeout<br>2) 若任務會跑較久，需在 config 或呼叫端放寬對應 timeout（見下方「可調的逾時」） |
| **執行到一半就停、有 timeout 錯誤** | **模型 API 或工具 request timeout**：上游（如 Gemini）或 web_fetch／browser 等逾時 | 同上，查日誌確認是「哪一層」逾時；必要時調高該層 timeout（若上游支援） |
| **長時間沒新輸出、最後也沒結果** | **連線中斷**：Cursor／客戶端與 OpenClaw Gateway 的 WebSocket 或 HTTP 斷開 | 1) 確認網路穩定、Gateway 沒重啟<br>2) 看 Gateway 日誌是否有 `closed`、`disconnect`<br>3) 若透過遠端或代理，注意 proxy/防火牆的 idle timeout |
| **對話很長之後開始中斷或亂掉** | **Context 過長／compaction**：session 接近 context window，觸發壓縮或錯誤 | 1) 看日誌是否有 `context window`、`compaction`、`reserveTokens` 相關訊息<br>2) 可調高 `compaction.reserveTokensFloor` 或縮短單次任務的對話長度 |
| **任務狀態一直「執行中」、但實際上沒在跑** | **Run 卡住或已失敗但狀態未更新**：執行端錯誤未回報、或客戶端沒輪詢到失敗 | 1) 看執行端（Gateway／agent 日誌）是否有 exception 或 timeout<br>2) 確認 Runs 列表有輪詢或即時更新（見 ROADMAP：執行紀錄即時更新） |

---

## 二、可調的逾時（openclaw-main 與設定）

- **Gateway 呼叫**  
  - 預設：`callGateway` 內建 **10 秒**；透過 `gateway.ts` 的 tool 呼叫多為 **30 秒**。  
  - 若任務內有「單次」Gateway 呼叫會跑超過 30 秒，需在該 tool 或呼叫鏈傳入更大的 `timeoutMs`（若 API 支援）。

- **瀏覽器工具（node proxy）**  
  - 預設約 **20 秒**（`DEFAULT_BROWSER_PROXY_TIMEOUT_MS`）。  
  - 長時間操作需在對應呼叫傳入更大 `timeoutMs`。

- **其他工具**  
  - `tools.web.fetch.timeoutSeconds`、`tools.web.search.timeoutSeconds` 等可在 **config** 調高（見 schema 註解）。  
  - 模型 API 的 request timeout 依各 provider 實作，多數在程式碼或 env 設定，需查對應模組。

- **Compaction（保留 token）**  
  - `agents.defaults.compaction.reserveTokensFloor`（預設 20000）可適度提高，讓壓縮晚一點觸發，減少「長對話後中斷」的機率（代價是更早吃滿 context）。

---

## 三、建議排查步驟

1. **重現一次**  
   盡量在「同一種任務、同一環境」下再跑一次，記下：  
   - 大約執行多久後中斷（例如 30 秒、2 分鐘）。  
   - 是否有錯誤訊息（畫面上或日誌）。

2. **看日誌**  
   - **Gateway 終端**：是否有 `timeout`、`closed`、`Error`、`aborted`。  
   - **執行 agent 的環境**：是否有 model API 錯誤、tool 逾時、compaction 相關 log。

3. **對照上表**  
   依「跑多久斷」「有無錯誤」「是否長對話後才斷」對到可能原因，再調對應 timeout 或連線／compaction 設定。

4. **若仍無法定位**  
   請提供：  
   - 中斷前後幾行的 Gateway／agent 日誌（可遮敏感資訊）。  
   - 任務類型（例如：連續 browser 操作、長時間 web_fetch、多輪對話）。  
   - 是否有固定「大約 N 分鐘就停」的規律（有助判斷是否為某個 timeout 值）。

---

## 四、相關文件

- **瀏覽器控制經常失敗**：`docs/瀏覽器控制經常失敗-排查說明.md`  
- **修復紀錄（Gateway／token）**：`docs/OpenClaw-修復紀錄報告.md`  
- **中控台 Runs 即時更新**：`openclaw-console-hub` 的 `docs/ROADMAP.md`（執行紀錄即時更新）
