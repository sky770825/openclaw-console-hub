# OpenClaw 可疑項目完整排查報告

檢查時間：2026-02-12  
範圍：`~/.openclaw/`、專案 `.env`、Gateway 日誌、agent 層設定。

---

## 1. 已修復項目

| 項目 | 問題 | 處理 |
|------|------|------|
| **GOOGLE_API_KEY 缺失（LaunchAgent）** | 日誌重複出現 `Missing env var "GOOGLE_API_KEY"`；LaunchAgent 不載入 `~/.openclaw/.env`，導致 merge 後的 `models.providers.google.apiKey` 為空。 | 已在 **openclaw.json** 的 `models.providers` 內新增 **google** provider，並寫入 apiKey（與 GEMINI_API_KEY 同值）。Gateway 由 LaunchAgent 啟動時不再依賴環境變數。 |
| **Gemini 3 Pro 未在 allowlist** | `agents.defaults.models` 缺少 `google/gemini-3-pro-preview`，若選用該模型會出現「not allowed」或 404。 | 已加入 `"google/gemini-3-pro-preview": {}`。 |

---

## 2. 設定與環境檢查結果

### 2.1 ~/.openclaw/openclaw.json

| 檢查項 | 狀態 | 說明 |
|--------|------|------|
| agents.defaults.model.primary | ✅ | `kimi/kimi-k2.5` |
| agents.defaults.model.fallbacks | ✅ | kimi、google/gemini-2.5-flash、anthropic/claude-sonnet-4-5-20250929 |
| agents.defaults.models（allowlist） | ✅ | 已含 google/gemini-3-pro-preview；格式皆為 `provider/id` → `{}` |
| models.providers.kimi | ✅ | apiKey 已寫在檔內 |
| models.providers.anthropic | ✅ | apiKey 已寫在檔內 |
| models.providers.ollama | ✅ | baseUrl 指向 localhost:11434 |
| models.providers.google | ✅ | **已新增**，apiKey 寫在檔內（避免 LaunchAgent 缺 env） |

### 2.2 ~/.openclaw/.env

| 變數 | 狀態 |
|------|------|
| GEMINI_API_KEY | ✅ 已設定 |
| GOOGLE_API_KEY | ✅ 已設定（與 GEMINI 同 key） |
| KIMI_API_KEY | ✅ 已設定 |
| ANTHROPIC_API_KEY | ✅ 已設定 |
| OPENAI_API_KEY | ✅ 已設定 |

終端機執行 `openclaw` 時會讀到此檔；**LaunchAgent 不會**，故 Google 改由 openclaw.json 內 apiKey 提供。

### 2.3 專案 .env（任務板後端）

| 變數 | 狀態 |
|------|------|
| SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY | ✅ 已設定 |
| PORT=3011 | ✅ |
| VITE_API_BASE_URL=http://localhost:3011 | ✅ |
| OPENCLAW_API_KEY / OPENCLAW_ENFORCE_WRITE_AUTH | ✅ 開發用設定 |

### 2.4 agents/main/agent/models.json 與 auth-profiles.json

| 項目 | 狀態 | 說明 |
|------|------|------|
| models.json | ⚠️ 與 openclaw 重疊 | 內含 ollama、kimi、anthropic、google；merge 時可能與 openclaw.json 重疊，但 openclaw 以 openclaw.json 為主，此檔為 agent 層覆寫。 |
| auth-profiles.json 的 kimi key | ⚠️ 與 openclaw 不同 | openclaw.json 的 kimi apiKey 為 `sk-9iskl...`；auth-profiles 裡 kimi 為 `sk-Sf2ZWl...`。若實際呼叫使用 agent 層 auth，可能與預期 key 不一致；若皆用 openclaw 層則無影響。建議以 openclaw.json 為單一來源，或兩邊改為同一 key。 |

---

## 3. 日誌與運行狀況

| 來源 | 發現 |
|------|------|
| gateway.err.log | 多次 `Missing env var "GOOGLE_API_KEY"`（已透過在 openclaw.json 新增 google provider 解決）；另有 AbortError、browser 未連線等，屬運行中偶發。 |
| Gateway 狀態 | 若仍顯示 not running，請執行 `openclaw gateway start` 或重載 LaunchAgent。 |

---

## 4. 建議後續動作

1. **重啟 Gateway**（讓新設定生效）  
   ```bash
   openclaw gateway restart
   # 若用 LaunchAgent：
   launchctl unload ~/Library/LaunchAgents/ai.openclaw.gateway.plist
   launchctl load ~/Library/LaunchAgents/ai.openclaw.gateway.plist
   ```

2. **確認無 GOOGLE_API_KEY 錯誤**  
   ```bash
   openclaw doctor --fix
   tail -20 ~/.openclaw/logs/gateway.err.log
   ```

3. **（可選）統一 Kimi key**  
   若希望 agent 層與 openclaw 層一致，可將 `~/.openclaw/agents/main/agent/auth-profiles.json` 內 kimi 的 key 改為與 openclaw.json 的 `models.providers.kimi.apiKey` 相同，或改為僅依賴 openclaw.json 的 kimi 設定。

4. **（可選）更新 OPENCLAW-CONFIG-CHECK.md**  
   文件中「google 未在 openclaw.json 自訂」已不成立，可改為「已在 openclaw.json 自訂 google provider，apiKey 寫在檔內」。

---

## 5. 快速檢查指令

```bash
# 檢查 primary 與 allowlist
jq '.agents.defaults.model.primary, (.agents.defaults.models | keys)' ~/.openclaw/openclaw.json

# 確認 google provider 存在
jq '.models.providers.google.apiKey' ~/.openclaw/openclaw.json

# 最近錯誤
grep -E "404|Missing|Error" ~/.openclaw/logs/gateway.err.log | tail -10
```

---

*本報告由排查腳本與手動檢查產生。*
