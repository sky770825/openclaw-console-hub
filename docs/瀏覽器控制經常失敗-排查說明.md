# 瀏覽器控制經常失敗 — 排查說明

控制瀏覽器（Chrome 擴充 / openclaw 內建瀏覽器）時若**經常失敗**，多半是下列幾類原因之一。依序檢查可縮小範圍。

---

## 一、失敗類型與對應解法

| 現象 / 錯誤訊息 | 可能原因 | 解法 |
|-----------------|----------|------|
| **Can't reach the OpenClaw browser control service**（或 timeout） | Gateway 沒開或沒在聽 | 1) 從 OpenClaw.app 選單或執行 `openclaw gateway` 啟動 Gateway<br>2) 確認 `~/.openclaw/openclaw.json` 的 `gateway.port`（如 18789）與實際一致 |
| **device identity required**（WS code=1008） | Chrome 擴充連 Gateway 時沒帶 token 或 token 錯 | 在擴充設定填與 `gateway.auth.token` 相同的值，並確認擴充在連線時有帶上該 token（見 [OpenClaw-修復紀錄報告.md](./OpenClaw-修復紀錄報告.md)） |
| **Chrome extension relay is running, but no tab is connected** | 擴充有連上，但沒有「已掛上」的分頁 | 在要控制的那個**分頁**上，**點一下工具列上的 OpenClaw 擴充圖示**，讓該分頁變成「已連接」（badge ON） |
| **tab not found** / **no attached Chrome tabs** | 沒有已掛上的分頁，或之前用的 targetId 已失效（分頁關掉/重整） | 1) 再次在目標分頁點擴充圖示掛上<br>2) 先跑一次 `action=tabs` 取得目前的 targetId，再對該 tab 操作 |
| **Chrome extension relay for profile "chrome" is not reachable** | 擴充 relay 服務沒起來或網址錯 | 確認本機 relay（cdpUrl）有在跑、Chrome 已開且擴充已啟用；必要時重開 Chrome 或重裝擴充 |
| **targetUrl required**（navigate / open） | 呼叫端只傳了 `url` 沒傳 `targetUrl` | 若已更新 openclaw-main：工具已同時接受 `url` 與 `targetUrl`，應可正常導航；若仍報錯請確認使用最新版 |
| **Port ... is in use ... but not by openclaw** | 該 profile 的 CDP port 被別的程式佔用 | 執行 `action=reset-profile profile=<profile名>` 清掉佔用，或手動關閉佔用該 port 的程式後重試 |

---

## 二、使用 Chrome 擴充時的建議流程（減少失敗）

1. **先確保 Gateway 有在跑**  
   終端執行 `openclaw gateway` 或從 OpenClaw.app 啟動，確認無報錯。

2. **擴充要帶對 token**  
   擴充設定裡的 Gateway Token 與 `openclaw.json` 的 `gateway.auth.token` 一致，避免被關閉連線（device identity required）。

3. **每次要控制前先「掛上分頁」**  
   打開要控制的那個網頁 → 在**該分頁**點 OpenClaw 擴充圖示 → 確認 badge 為 ON（已連接）。

4. **操作前可先查 tabs**  
   若 AI 或腳本會指定 targetId，可先呼叫 `action=tabs` 取得目前已連接的 tab 清單與 targetId，再進行 navigate / snapshot / act，避免用到已關閉分頁的 targetId。

5. **分頁關掉或重整後要重掛**  
   關閉或重新整理分頁後，該 targetId 會失效，需重新在該分頁點擴充圖示，並視需要重新取 tabs。

---

## 三、若仍經常失敗可再查的點

- **網路 / 防火牆**：本機 127.0.0.1 的 Gateway port 是否被阻擋。
- **Chrome / 擴充版本**：擴充與 OpenClaw 建議版本是否相符，必要時更新或重裝擴充。
- **日誌**：Gateway 終端輸出、或瀏覽器開發者工具 Console，看失敗當下是上述哪一類錯誤（timeout、1008、tab not found 等），再對照本表逐項排除。

---

## 四、相關文件

- **Gateway / token / device identity**：`OpenClaw-修復紀錄報告.md`  
- **targetUrl 與 url 別名**：同修復紀錄報告 §3.2
