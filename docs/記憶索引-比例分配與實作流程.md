# 記憶索引 — 比例分配與實作流程

> **目標：** 在 3／5／10 次處理的視窗內，依「命中」計算各區塊比例；若某主題已佔 70～80%，則不再重複引入或處理比例很低的區塊，減少無效載入與 token。

---

## 一、概念

- **視窗（Window）：** 只統計「最近 N 輪」的命中情況，N 可設為 3、5 或 10。
- **每輪一筆：** 每一輪（一來一往或一次任務處理）記錄「本輪實際用到的記憶區塊」。
- **比例：** 在視窗內，各區塊命中次數 ÷ 總命中次數 = 該區塊比例（例如 70% 重要決定、20% 關於老蔡、10% 待辦）。
- **決策：** 若已有區塊 ≥ 門檻（如 70% 或 80%），視為**主導主題**；之後只對「主導 + 本輪訊息有明確匹配」的區塊做載入／查詢，**不主動再引入**比例很低或為 0 的區塊，避免重複處理。

---

## 二、名詞定義

| 名詞 | 說明 |
|------|------|
| **一輪（turn）** | 一次完整互動單位：例如一則使用者訊息 + Agent 一次回覆；或一次任務從觸發到結束。實作上可簡化為「每回覆一次算一輪」。 |
| **命中（hit）** | 本輪有對某個「記憶區塊」做 memory_search 或讀取 MEMORY_FULL 對應段落並納入回答。區塊對應 MEMORY.md 的標題（如「重要決定」「關於老蔡」「待辦」）。 |
| **區塊（section）** | MEMORY.md 裡的分類，與 MEMORY_FULL 段落對應，例如：關於我、關於老蔡、重要決定、待辦、教訓、時間／近期、技術／記憶。 |
| **視窗大小** | 最近 K 輪（K = 3、5 或 10），只在這 K 輪內算比例。 |
| **主導門檻** | 若某區塊比例 ≥ 此值（如 0.7 或 0.8），該區塊視為「主導」；本輪僅載入／查詢主導 + 與使用者訊息明確匹配的區塊。 |

---

## 三、資料結構（index_state.json）

```json
{
  "window_size": 5,
  "dominant_threshold": 0.7,
  "turns": [
    {
      "turn_id": 1,
      "ts": "2026-02-08T12:00:00Z",
      "sections_hit": ["重要決定", "待辦"]
    },
    {
      "turn_id": 2,
      "ts": "2026-02-08T12:05:00Z",
      "sections_hit": ["重要決定"]
    }
  ],
  "proportions": {
    "重要決定": 0.7,
    "關於老蔡": 0.2,
    "待辦": 0.1
  },
  "current_topic": "Ollama Fallback",
  "topic_summary": "",
  "last_updated": "2026-02-08T12:05:00Z",
  "miss_count": {}
}
```

### 欄位說明

| 欄位 | 說明 |
|------|------|
| **window_size** | 只保留最近 N 輪（3／5／10），超過的從 `turns` 前端移除。 |
| **dominant_threshold** | 比例 ≥ 此值視為主導（建議 0.7～0.8）。 |
| **turns** | 陣列，每輪一筆：`turn_id`、`ts`、`sections_hit`（本輪命中的區塊名稱列表）。只保留最近 `window_size` 筆。 |
| **proportions** | 在目前視窗內，各區塊的命中比例（命中次數 / 總命中次數）。每輪結束後重算。 |
| **current_topic** / **topic_summary** | 與 MEMORY_TOPIC.md 對齊的當前主題（可選，或只保留在 MEMORY_TOPIC.md）。 |
| **miss_count** | 各區塊「連續未命中」次數，供未命中滿 N 次建議精簡索引用。 |

---

## 四、每輪流程（實作步驟）

### 4.1 輪開始時（決定本輪要考慮哪些區塊）

1. 讀取 `memory/index_state.json`（若無則跳過比例邏輯）。
2. 若 `proportions` 存在且某區塊 ≥ `dominant_threshold`（如 70%）：
   - 該區塊視為**主導**。
   - **本輪只對以下區塊做 memory_search／讀取：**
     - 主導區塊（可固定帶入或優先查）；
     - **使用者訊息或任務中明確出現關鍵字**的區塊（即「有匹配」的區塊）。
   - **不主動引入**比例很低（如 <10%）或為 0 的區塊；除非使用者訊息明顯提到該類關鍵字，才查。
3. 若尚無主導（比例都 < 門檻）：
   - 照舊：依 MEMORY.md 關鍵字，有匹配就查。

### 4.2 輪結束時（更新狀態）

1. 根據本輪實際行為，列出**本輪命中的區塊**（例如本輪查了「重要決定」與「待辦」→ `sections_hit: ["重要決定", "待辦"]`）。
2. 新增一筆到 `turns`，並只保留最近 `window_size` 筆（例如 5 筆）。
3. **重算 proportions：**
   - 在目前 `turns` 內，統計每個區塊出現次數；
   - 各區塊比例 = 該區塊出現次數 / 總命中次數（總命中次數 = 所有 turns 的 sections_hit 長度加總）。
4. **更新 miss_count：**
   - 本輪有命中的區塊 → 該區塊 `miss_count = 0`；
   - 本輪未命中的區塊 → 該區塊 `miss_count += 1`；
   - 若某區塊 `miss_count >= 3`（可設），可在回覆或日誌中**建議**「可考慮從 MEMORY.md 索引移除或合併」。
5. 若主導區塊已穩定（例如連續 2～3 輪比例 ≥ 70%）→ 可選：同步更新 **MEMORY_TOPIC.md**（當前主題 + 可選一句摘要）。

---

## 五、比例範例（5 輪視窗）

| 輪次 | sections_hit | 累計（最近 5 輪） |
|------|--------------|-------------------|
| 1 | 重要決定 | 重要決定:1 |
| 2 | 重要決定、待辦 | 重要決定:2, 待辦:1 |
| 3 | 重要決定 | 重要決定:3, 待辦:1 |
| 4 | 重要決定 | 重要決定:4, 待辦:1 |
| 5 | 重要決定 | 重要決定:5, 待辦:1 |

- 總命中次數 = 5+2+1+1+1 = 10（或簡化為「區塊出現次數」：重要決定 5 次、待辦 1 次 → 總 6 次，比例 重要決定 5/6≈83%、待辦 1/6≈17%）。  
  **註：** 比例可依「區塊出現次數」或「該區塊在幾輪內被命中」定義，二擇一即可。建議用「區塊出現次數」較直觀。

- 若總命中 = 6（重要決定 5、待辦 1），則 proportions = { "重要決定": 0.833, "待辦": 0.167 }。
- 門檻 0.7 → 「重要決定」為主導；下一輪只主動載入／查詢「重要決定」，其餘僅在使用者訊息明確匹配時才查，**不再重複引入**待辦以外的低比例區塊。

---

## 六、何時「不重複引入」的具體意涵

- **不重複引入：** 不在每輪開頭就對「所有 MEMORY.md 區塊」做一輪 memory_search；改為只對「主導區塊 + 本輪訊息有關鍵字匹配的區塊」查詢。
- **效果：** 當話題已集中在 70～80% 的主題時，其他 20～30% 或 0% 的區塊不會每輪都被帶入或重複處理，省 token、也減少無關內容干擾。

---

## 七、實作優先順序建議

1. **Phase 1（手動／半自動）：**  
   - 先有 `index_state.json` 的 schema（window_size、turns、proportions、dominant_threshold）。  
   - Agent 在每輪結束時寫入本輪 `sections_hit`，並重算 `proportions`（可寫在說明或簡單腳本）。  
   - 人眼檢視 proportions；若某區塊 ≥ 70%，下一輪手動或口頭提醒「這輪只處理 OOO 相關 + 有匹配的」。

2. **Phase 2（Agent 依狀態決策）：**  
   - 輪開始時 Agent 讀取 index_state，若存在主導區塊則本輪只查「主導 + 訊息匹配」的區塊，不主動查低比例／0 的區塊。  
   - 輪結束時依實際查詢結果更新 turns + proportions + miss_count。

3. **Phase 3（可選）：**  
   - 小工具或腳本：讀 index_state，輸出「本輪建議考慮的區塊」清單，供 Agent 或外部流程使用。

---

## 八、與 MEMORY_TOPIC、未命中調整的關係

- **MEMORY_TOPIC.md**：當前主題名稱與一句摘要；可由「比例穩定主導」時寫入（例如連續多輪 ≥ 70%）。
- **未命中調整**：`miss_count` 滿 3（或 N）的區塊，建議從 MEMORY.md 索引移除或合併；與比例分配並行，比例負責「本輪載入誰」，未命中負責「長期精簡索引」。

---

_實作時可先固定 window_size=5、dominant_threshold=0.7，再依使用情況改為 3 或 10、0.8 等。_
