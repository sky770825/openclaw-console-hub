# Token 優化總覽與後續建議

> 目前已做的自動調節（一般聊天輕量、索引對齊、主題與比例）已經能把一般招呼壓到約 0.5K、任務時約 18～19K。以下是**還可再優化**與**你可能沒想到**的幾點建議。

---

## 一、目前已上線的優化（摘要）

| 項目 | 效果 |
|------|------|
| **一般聊天輕量模式** | 「你好」「嗨」等 → 只帶 IDENTITY + 精簡 USER + 一句規則 → **約 0.5K** |
| **索引對齊記憶庫** | MEMORY.md 只列有對應內容的關鍵字；沒有資料不設索引 | 少約 700～950 token（bootstrap） |
| **主題 + 比例分配** | 主導區塊 ≥70% 時只載入主導+匹配的記憶，不重複引入低比例區塊 | 變動部分從 2～4K 降到約 0.5～1.5K |
| **當前主題 MEMORY_TOPIC** | 多輪同一話題時寫入當前主題，該主題關鍵字高優先 | 提高命中、減少無效查詢 |

---

## 二、建議再做的（你沒想到或可再壓的部分）

### 1. 每日筆記改為「關鍵字觸發再讀」

- **現狀：** AGENTS 寫「Read memory/今天+昨天」，Agent 每輪可能都去讀 `memory/YYYY-MM-DD.md`（兩檔約 1.1K token）。
- **建議：** 改為「只有當使用者訊息或任務涉及 **今天、昨天、前天、近期、那天、排程** 等關鍵字時，再讀 memory/今天與 memory/昨天」；其餘輪次不讀。
- **效果：** 多數輪次可再省約 **1K token**。
- **實作：** 在 AGENTS.md 把 daily 的說明改成上述條件句即可（行為交給 Agent 判斷）；若 Gateway 有自動注入每日檔，才需在程式端改為依關鍵字或 mode 注入。

### 2. 技能列表分級注入（若 Gateway 會帶入）

- **現狀：** 若系統會把「已啟用技能」的名稱+描述打進 prompt，技能一多就佔不少 token。
- **建議：** 分級注入——例如「必帶」只列 3～5 個最常用（如 session-logs、任務板、Cursor）；其餘寫「見 SKILLS_INDEX，按需 restore-skill」。或與 **bootstrapMode** 連動：light 不帶技能列表，full 才帶精簡版或完整版。
- **效果：** 技能列表可從數千字壓到數百字，省 1K+ token。

### 3. 長對話時修剪或摘要歷史

- **現狀：** 對話愈長，歷史訊息愈多，context 愈大。
- **建議：** 當 turn 數或總 token 超過某閾值時，只保留「最近 N 輪」完整內容，較早的改為**一句摘要**（例如「之前討論過 Fallback Bot 修復與任務板 API」），不再整段貼上。
- **效果：** 長線對話可省數 K token；實作需 Gateway 或 session 層支援摘要或滑動視窗。

### 4. HEARTBEAT / SOUL 改為「需要時再讀」

- **現狀：** 每次 full 都會帶 HEARTBEAT.md、SOUL.md 全文（合計約 7K token）。
- **建議：**  
  - **HEARTBEAT**：只在「該做心跳檢查的時段」或「使用者問到信箱/日曆/提醒」時，才把 HEARTBEAT 納入；其餘輪次用一句「心跳規則見 HEARTBEAT.md，需要時再讀」。  
  - **SOUL**：保留精簡版（幾條核心原則），長文與範例移到 SOUL_FULL.md，需要時再讀。
- **效果：** 可再省約 3～5K token（依實際精簡程度）。

### 5. 可選「medium」模式（進階）

- **概念：** 除了 light（招呼）與 full（任務/記憶），多一個 **medium**：使用者有問問題但不像「幫我記下來」或執行任務，例如「你覺得這樣做可以嗎？」。  
  - **medium**：帶 IDENTITY + USER + MEMORY 索引 + TOOLS 精簡（不含 HEARTBEAT/SOUL 全文），不帶技能詳表。  
- **效果：** 簡單問答可壓在約 5～8K，又不至於完全沒脈絡。
- **實作：** 需在分類器加一類（例如 `isCasualChat` → light，`isSimpleQuestion` → medium，否則 full），並在 bootstrap 清單中定義 medium 要帶哪些檔。

### 6. 用量觀察（可選）

- **建議：** 若想看到「這輪是 light 還是 full」「大概用了多少 token」，可在 log 或 debug 輸出中紀錄：  
  - `bootstrapMode: "light" | "full"`  
  - 注入的 context 字數或 token 估計值（例如 bootstrap 總字數）。  
- **好處：** 方便驗證輕量模式有被觸發、或日後調校閾值與分類規則。

---

## 三、總覽表：還可壓到多少？

| 階段 | 情境 | 預估單次請求 |
|------|------|--------------|
| **現在** | 一般聊天 | **~0.5K**（已實作） |
| **現在** | 任務/主題（full） | **~18～19K** |
| **+ 每日筆記關鍵字觸發** | full 且未提到今天/昨天 | **~17～18K**（省約 1K） |
| **+ 技能列表分級** | full | **~16～17K**（再省約 1K+） |
| **+ HEARTBEAT/SOUL 按需** | full | **~12～14K** |
| **+ 長對話歷史修剪** | 多輪長對話 | 避免持續膨脹，可壓在 **~20K 以內** |

---

## 四、小結

- **你已經在做對的事：** 自動調節（輕量/完整）、索引對齊、主題與比例，都是省 token 又維持體驗的關鍵。
- **接下來可優先：**  
  1）每日筆記改為關鍵字觸發再讀（改 AGENTS 說明即可）；  
  2）若有注入技能列表，再考慮分級或與 bootstrapMode 連動；  
  3）有餘力再動 HEARTBEAT/SOUL 精簡或按需讀取。  
- **可選：** medium 模式、長對話修剪、用量紀錄，依需求再補上即可。

這樣整體方向就完整了：**自動調節 + 按需載入 + 索引與比例**，能壓的都已考慮進去，剩下就是依優先級逐步實作。
