# 記憶寫入與索引 — 說明與實施方式

> **快速重點**  
> - 索引在**本機**（QMD 或 builtin），**雲端模型不索引**你的檔案，只收到我們送出的那一包。  
> - 寫入 **MEMORY_FULL.md**、**memory/YYYY-MM-DD.md** → 本機自動/手動建索引 → **memory_search** 查到的片段再送給雲端。  
> - **索引對齊原則：** 只有記憶庫裡**已經有資料**的主題才在 MEMORY.md（關鍵字索引）裡設關鍵字；沒有資料就不設索引，避免觸發搜尋卻找不到內容。

---

## 一、雲端大模型有在「索引」這些記憶嗎？

**沒有。** 索引與搜尋都在**你這台設備（本機）**完成，雲端只收到「我們送出去的那一包內容」。

### 流程簡圖

```
本機
  ① 寫入  →  Agent 用 edit/write 寫進 MEMORY.md、memory/*.md
  ② 索引  →  QMD 或 builtin 讀取檔案，建向量/關鍵字索引（存本機）
  ③ 搜尋  →  memory_search(query) 在本機查索引，回傳幾段摘要
  ④ 組裝  →  OpenClaw 把「系統提示 + 對話 + 搜尋結果」送給雲端 API

雲端（如 Gemini）
  → 只收到「這一包」，不碰你的磁碟、不建索引
  → 根據這包生成回覆，回傳後不保留你的檔案
```

- **建立記憶與索引** = 本機完成（寫檔 + QMD/builtin 索引）。  
- **雲端大模型** = 只根據我們送出的那一包做生成，不替你索引或儲存。

---

## 二、本機誰在索引？何時更新？

| 後端 | 誰在索引 | 索引位置 | 何時更新 |
|------|----------|----------|----------|
| **QMD** | 獨立程式 `qmd` | 如 `~/.openclaw/agents/main/qmd/` | 檔案變更後 debounce / 定時 / 開機；可手動 `openclaw memory status --index` |
| **builtin** | OpenClaw 內建 | state dir 下的 store | 寫入或執行 memory 相關指令時 |

- 未裝 QMD 或未設 `memory.backend: "qmd"` → 使用 **builtin**，一樣會索引 MEMORY.md、memory/*.md。  
- 確認索引：`openclaw memory status`（必要時加 `--deep --index`）。

---

## 三、實施方式：寫下來 + 分類 + 提取

### 寫到哪、寫什麼

| 檔案／位置 | 用途 |
|------------|------|
| **MEMORY_FULL.md** | 長期：決定、偏好、待辦、教訓、費用、人設（完整內容） |
| **MEMORY.md** | 關鍵字索引（只列「記憶庫有對應內容」的關鍵字或 Notion 頁面 ID，省 Token） |
| **memory/YYYY-MM-DD.md** | 當日流水帳、補充，或 pre-compaction 自動寫入 |
| **Notion** | 若已用 Notion 當記憶庫：完整內容可放在 Notion 頁面/資料庫，Agent 用 Notion API 讀取與**撰寫**；本機 MEMORY.md 只放「關鍵字 → Notion 頁面」索引。詳見 [OpenClaw連上Notion-說明](./OpenClaw連上Notion-說明.md) 第六節。 |

### 何時寫下來

- 使用者說：「記下來」「寫進 MEMORY」「這個要記住」
- 對話出現：重要決定、待辦、偏好、教訓、費用、約定
- 系統：pre-compaction 會把重點寫進 memory/*.md

### 分類與格式（方便 memory_search）

- **MEMORY.md**：用標題分區（`## 重要決定`、`## 待辦`、`## 偏好` 等），寫入時歸到對應區塊。
- **每段加日期**：例如 `2026-02-08：費用紀錄：…`，有利搜尋與提取。
- **memory/日期檔**：檔名即日期，方便「那天發生什麼」查詢。

### 檢查索引

- 寫完後可執行 `openclaw memory status --index` 觸發/確認索引。
- 之後問「之前我們決定過什麼？」等問題，Agent 會用 **memory_search** 從本機取回相關段落，放進送給雲端的那一包。

---

## 四、索引與記憶庫對齊原則

- **記憶庫** = 實際有寫入的內容：**MEMORY_FULL.md**、**memory/YYYY-MM-DD.md**。
- **索引** = **MEMORY.md** 裡的關鍵字列表（Gateway 每次載入這份，省 Token）。
- **原則：** 只有記憶庫裡**已經有該主題內容**時，才在 MEMORY.md 增加對應關鍵字；**沒有資料就不要設索引**，否則會觸發 memory_search 卻查不到東西。
- **流程：** 先寫入 MEMORY_FULL 或 memory/日期檔 → 再在 MEMORY.md 補上對應關鍵字。不要先預設「可能用到的」關鍵字。

---

## 五、一句話總結

**寫下來**（MEMORY_FULL.md + memory/日期檔）→ **本機** QMD/builtin **建索引** → **MEMORY.md 只列有對應內容的關鍵字** → **memory_search** 取片段 → 放進送給雲端的內容；**雲端不索引、不儲存**你的檔案，只根據我們送出的那一包回答。
