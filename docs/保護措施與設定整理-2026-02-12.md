# 保護措施與設定整理（2026-02-12）

針對「相關保護措施」與「設定調整以避免混亂」兩點整理現況與建議。

---

## 一、保護措施現況與建議

### 1.1 任務板後端 API（server）

| 項目 | 現況 | 建議 |
|------|------|------|
| **寫入 API 金鑰** | `OPENCLAW_API_KEY` + `OPENCLAW_ENFORCE_WRITE_AUTH=true` 時，POST/PATCH/PUT/DELETE 須帶 `x-api-key` 或 `Authorization: Bearer <key>` | 正式環境務必設定強隨機 key，勿用 `.env.example` 的 `replace-with-strong-key`；可選分層：`OPENCLAW_READ_KEY` / `OPENCLAW_WRITE_KEY` / `OPENCLAW_ADMIN_KEY` |
| **讀取 API 金鑰** | 預設 GET 不需 key；`OPENCLAW_ENFORCE_READ_AUTH=true` 時連讀取也需 key | 對外或內網敏感時可開啟 |
| **限流** | 每 IP 15 分鐘 1000 次 | 可依部署環境用 `rateLimit.max` 或反向代理再限流 |
| **CORS** | 僅允許固定 localhost/127.0.0.1 埠 | **正式環境**須透過 env 加入前端實際 origin，否則瀏覽器會擋（見下方「避免混亂」） |
| **Body 大小** | `express.json({ limit: '200kb' })` | 已限制，可維持 |
| **Helmet** | 已啟用 | 維持 |

### 1.2 OpenClaw Gateway

| 項目 | 現況 | 建議 |
|------|------|------|
| **gateway.auth** | `mode: "token"`，token 在 openclaw.json | `bind=lan` 時必填；建議 token 至少 24 字元隨機（可 `openssl rand -base64 24`），並與 Control UI / 擴充一致 |
| **openclaw.json 權限** | 已設 `chmod 600` | 維持，避免被其他帳號讀取 |
| **安全稽核** | 可執行 `openclaw security audit`（必要時 `--deep`） | 定期跑，處理 critical/warn（如 plugins.allow、sandbox、token 強度） |

### 1.3 Supabase

| 項目 | 現況 | 建議 |
|------|------|------|
| **RLS** | 表皆啟用 RLS；設計為僅 **service_role**（後端）可存取，anon 無政策 | 勿對 anon 開放寫入政策；若未來要給前端直連，再以「僅讀 + 政策約束」為限 |
| **金鑰** | `SUPABASE_SERVICE_ROLE_KEY` 僅後端使用 | 絕不寫進前端或開放給瀏覽器 |

### 1.4 Telegram / 敏感設定

| 項目 | 現況 | 建議 |
|------|------|------|
| **OpenClaw botToken** | 在 openclaw.json | 若曾提交到版控請立刻輪換；日常勿把 openclaw.json 放到公開 repo |
| **任務板 TELEGRAM_*** | 在 server 的 .env | .env 勿提交；.env.example 只留變數名與說明 |
| **groupAllowFrom** | 已設定群組可觸發的使用者 ID | 新增使用者時記得補上 ID |

### 1.5 n8n Webhook 轉發

| 項目 | 現況 | 建議 |
|------|------|------|
| **主機白名單** | `N8N_WEBHOOK_ALLOWLIST` 或從 `N8N_API_URL` / `N8N_WEBHOOK_RUN_NEXT` 解析 host | 只允許已知 n8n 主機，避免被濫用轉發到內網 |

---

## 二、設定調整以避免混亂

### 2.1 後端 CORS 與正式環境

- **問題**：目前 `allowedOrigins` 僅寫死 localhost/127.0.0.1 埠，正式環境前端網址不同會導致 CORS 錯誤、難以除錯。
- **建議**：以環境變數支援正式來源；**已實作**：後端讀取 `ALLOWED_ORIGINS`（逗號分隔多個 `https://...`），部署時在 server 的 .env 設定即可，本機開發仍保留既有 localhost list。見專案根目錄 `.env.example`。

### 2.2 OpenClaw 技能「任務板 URL」

- **現況**：`~/.openclaw/openclaw.json` 的 `skills.entries.openclaw-taskboard.env.OPENCLAW_TASKBOARD_URL` 為 `http://localhost:3011`。
- **建議**：本機用 OpenClaw 呼叫任務板時維持 localhost；若任務板部署到正式機且 OpenClaw 在別台機器或從外網連，需改為正式 URL，否則技能會連不到。

### 2.3 Gateway 重複 plist（避免搞混）

- **現況**：存在 `ai.openclaw.gateway.plist`（目前使用）與 `com.openclaw.gateway.plist`（舊）。
- **建議**：若確定只用 `openclaw gateway` 安裝的服務，可卸載舊的，避免以後停錯服務：
  ```bash
  launchctl bootout gui/$UID/com.openclaw.gateway 2>/dev/null
  rm ~/Library/LaunchAgents/com.openclaw.gateway.plist
  ```

### 2.4 金鑰與 .env 約定

- **OPENCLAW_API_KEY**：正式環境必須改成強隨機值，且勿提交到版控。
- **.env**：僅在 server 目錄使用，不要複製到前端或 OpenClaw 目錄造成「同一變數多處定義」的混亂；OpenClaw 用 `~/.openclaw/.env` 與 openclaw.json。

### 2.5 Telegram 雙 Bot 分工（再提醒）

- **OpenClaw 對話**：只用 openclaw.json 的 `channels.telegram.botToken`（收發與模型）。
- **任務板通知**：用 `TELEGRAM_BOT_TOKEN` + `TELEGRAM_CHAT_ID`（只發不收）。
- **/stop 輪詢**：建議獨立 `TELEGRAM_STOP_BOT_TOKEN`（第二個 bot），避免與 OpenClaw 搶同一 bot 的 getUpdates。

### 2.6 檢查清單對照

可與 `docs/需要注意而容易忽略的檢查清單.md` 一併使用：

- 安全：Gateway token 強度、plugins.allow、sandbox/fallback 模型
- 通道：Telegram 配對、groupAllowFrom、群組 @ 提及
- Gateway：更新後重啟、bind=lan 時 token 必填
- 模型：primary/fallback、429 時行為、Ollama 健康
- 日常：`openclaw status`、`openclaw doctor`、出問題時 `openclaw logs --follow`

---

## 三、Telegram 與 OpenClaw 穩定性（減少代碼變動影響）

為避免因代碼或設定變動導致整個系統掛掉，可配合：

- **`docs/Telegram與OpenClaw-穩定性建議.md`**：說明誰會影響誰、改設定前備份與驗證、升級後重啟、可選健康檢查與 ThrottleInterval。
- **`scripts/gateway-healthcheck.sh`**：可選定時探測 Gateway，失敗時重啟並帶冷卻時間，可交給 cron 執行。

---

## 四、小結

- **保護措施**：後端 API 有寫入金鑰與限流、Supabase 有 RLS、Gateway 有 token、n8n 有主機白名單；建議補強正式環境 CORS、Gateway token 長度與定期 security audit。
- **避免混亂**：正式環境 CORS 改由 env 設定、任務板 URL 依部署環境調整、清理重複 Gateway plist、金鑰與 .env 約定清楚、Telegram 雙 Bot 分工明確，並與既有檢查清單對照即可。
- **穩定性**：見「三、Telegram 與 OpenClaw 穩定性」與 `docs/Telegram與OpenClaw-穩定性建議.md`。
