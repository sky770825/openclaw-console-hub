# 一般聊天 vs 主題／記憶 — 輕量模式設計

> **目標：** 當使用者只是打招呼或簡單閒聊（例如「你好」「嗨」）時，**不要**把完整 bootstrap（AGENTS、SOUL、MEMORY、TOOLS…）都帶入，以節省 token；只有當進入**特定主題**、或說「幫我記下來」、或有**記憶點**時，才載入完整 context 並可寫入記憶。

---

## 一、兩種情境

| 情境 | 範例 | 預期行為 |
|------|------|----------|
| **一般聊天** | 你好、嗨、在嗎、早安、哈囉、hey、ok、好喔 | 簡短回覆即可，**不需**載入 MEMORY、TOOLS、HEARTBEAT、完整 AGENTS；可只帶身份 + 稱呼（極少 token） |
| **主題／任務／記憶** | 聊到具體事、執行某件事、「這個幫我記下來」、有明確記憶點 | **才**載入完整 bootstrap、記憶索引、工具；可做 memory_search、寫入 MEMORY、呼叫工具 |

---

## 二、判定方式（可實作）

### 2.1 視為「一般聊天」的條件（同時滿足較保險）

- **內容特徵：** 純打招呼、寒暄、極短句，且**沒有**任務／記憶關鍵字。
- **範例關鍵字（可設為清單）：**  
  `你好、嗨、在嗎、早安、早啊、哈囉、嘿、hey、hi、hello、在嗎、嗯、好喔、ok、好、再見、bye、謝啦、thanks`
- **長度可選：** 例如 trimmed 後長度 < 某閾值（如 30～50 字）才考慮為輕量，避免長文被誤判。

### 2.2 視為「主題／任務／記憶」、必須載入完整 context

- **觸發詞／行為：**  
  - 明確記憶：`記下來、幫我記、寫進 MEMORY、記住、這個要記`  
  - 任務感：`幫我、請你、執行、查一下、看一下、檢查、設定、幫我寫、幫我找`  
  - 主題感：訊息較長、含專有名詞（人名、專案名、日期）、或上一輪已在聊具體話題（可選：結合對話歷史）
- **實作上：** 若出現上述任一種，就不走「一般聊天」，改走完整 bootstrap。

### 2.3 簡單流程

```
收到使用者訊息
  → 先做「一般聊天」判定（關鍵字 + 長度 + 排除任務/記憶觸發詞）
  → 若為一般聊天：使用「輕量 bootstrap」（見下）
  → 否則：使用「完整 bootstrap」+ 必要時 memory_search / 寫入記憶
```

---

## 三、輕量 bootstrap（一般聊天時帶入的內容）

目標：**只帶最少必要資訊**，讓模型能自然回一句招呼、不暴露隱私、不呼叫工具。

建議內容（可調）：

| 項目 | 內容範例 | 預估 token |
|------|----------|------------|
| 身份 | IDENTITY.md 全文（或一句「你是小蔡」） | ~300 |
| 稱呼 | USER.md 只取「如何稱呼」一行（例：老蔡） | ~50 |
| 輕量規則 | 一句：「一般聊天模式：簡短回覆即可，不查記憶、不呼叫工具；若使用者接下來提出具體問題或說記下來，下一輪會切換為完整模式。」 | ~80 |
| **合計** |  | **約 400～500 token** |

其餘（AGENTS、SOUL、TOOLS、HEARTBEAT、MEMORY、每日筆記、技能列表）**一律不帶**，等下一輪使用者進入主題或說「記下來」再帶。

---

## 四、實作層級

### 方案 A：僅 Agent 指令（不省 bootstrap token）

- 在 AGENTS.md 寫：若使用者只說你好、嗨等，**簡短回覆，不呼叫 memory_search、不寫入記憶、不執行工具**。
- **優點：** 不需改 Gateway 程式。  
- **缺點：** 完整 bootstrap 仍會每輪送給模型，token 不會少，只是 Agent 行為變省事。

### 方案 B：Gateway 依訊息分類選 bootstrap（真正省 token）★ 建議

- 在組裝 system prompt **之前**，對**本輪使用者訊息**做一次分類：一般聊天 vs 主題／任務／記憶。
- 若為一般聊天 → 只注入「輕量 bootstrap」（上表）；  
  否則 → 照現有邏輯注入完整 bootstrap。
- **優點：** 一般聊天時 request 可從 ~17K 降到約 **~0.5K**（僅輕量內容 + 對話），省 token 明顯。
- **實作點：**  
  - OpenClaw：在 `resolveBootstrapContextForRun` 的呼叫端（例如 `pi-embedded-runner/run/attempt.ts`）取得本輪 `prompt`，先呼叫分類函式（如 `isCasualChat(prompt)`），再傳入 `bootstrapMode: "full" | "light"`。  
  - `resolveBootstrapContextForRun`（或同層）依 `bootstrapMode` 決定要載入的檔案集合：light 時只載 IDENTITY + 極簡 USER（或一個 CHAT_ONLY.md），full 時維持現狀。

### 方案 C：混合（先 Gateway 輕量，必要時下一輪自動變 full）

- 第一輪：使用者說「你好」→ Gateway 判為一般聊天 → 輕量 bootstrap，Agent 簡短回。
- 下一輪：使用者說「幫我記下來明天要開會」→ Gateway 判為主題／記憶 → 完整 bootstrap；Agent 可 memory_search、寫入 MEMORY。
- 不需額外「切換開關」，完全由**本輪訊息內容**決定。

---

## 五、邊界與注意

- **錯殺：** 若使用者說「你好，想問一下上週我們討論的那個點子」→ 應視為主題，不要判成一般聊天（可規則：含「討論、記下來、上次、之前」等就當主題）。
- **多輪：** 若希望「上一輪在聊主題、這輪只回 ok」仍帶完整 context，可選：當上一輪為 full 且本輪極短，暫時仍用 full；或一律以本輪訊息為準（實作簡單）。
- **設定開關：** 可在 config 提供 `agents.defaults.casualChatLightBootstrap: true/false`，關閉則永遠 full，方便除錯或不需要時關掉。

---

## 六、小結

1. **判定：** 一般聊天 = 打招呼／極短句 + 無任務／記憶觸發詞；其餘 = 主題／任務／記憶，載入完整 context。  
2. **輕量時不帶：** AGENTS、SOUL、TOOLS、HEARTBEAT、MEMORY、每日筆記、技能列表。  
3. **輕量時只帶：** 身份 + 稱呼 + 一句「簡短回覆、不查記憶不呼叫工具」。  
4. **實作建議：** 在 Gateway 組裝 prompt 處依訊息分類選擇「light」或「full」bootstrap，才能實質降低 token。

---

## 七、已實作（OpenClaw 程式）

- **分類器：** `src/agents/casual-chat-classifier.ts` — `isCasualChat(text)`：打招呼／極短句且無任務／記憶觸發詞 → true；否則 false。
- **Bootstrap：** `resolveBootstrapContextForRun(..., bootstrapMode?: "full" | "light")`。`light` 時只帶 IDENTITY + USER（前兩行／200 字）+ 一句「一般聊天模式」說明。
- **接線：** `pi-embedded-runner/run/attempt.ts` 依本輪 `params.prompt` 呼叫 `isCasualChat`，傳入 `bootstrapMode`；可設 `agents.defaults.casualChatLightBootstrap: false` 關閉此行為。
