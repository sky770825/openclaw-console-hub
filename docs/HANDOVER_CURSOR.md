# ğŸ”„ Cursor Agent äº¤æ¥æ–‡ä»¶

**ä¾†æº**: Codex å·²å®Œæˆå¾Œç«¯å¯¦ä½œï¼Œç¾äº¤æ¥çµ¦ Cursor æ¥æ‰‹é©—è­‰èˆ‡å¾ŒçºŒé–‹ç™¼
**æ—¥æœŸ**: 2026-02-11
**ä»»å‹™æ¿è·¯å¾‘**: `/Users/caijunchang/openclawä»»å‹™é¢ç‰ˆè¨­è¨ˆ/`

---

## âœ… å·²å®Œæˆï¼ˆCodexï¼‰

### 1. å¾Œç«¯ API (`server/src/index.ts`)
å·²å¯¦ä½œä»¥ä¸‹æ–°ç«¯é»ï¼š

```typescript
// Agent Protocol æ ¸å¿ƒ API
POST /api/openclaw/command      // Agent åŸ·è¡Œå®Œå›å ±
POST /api/openclaw/interrupt    // è«‹æ±‚äººå·¥ä»‹å…¥
POST /api/openclaw/resume       // äººå·¥æ±ºå®šå¾Œæ¢å¾©
POST /api/openclaw/automations/:id/run  // åŸ·è¡Œè‡ªå‹•åŒ–
```

**SharedState çµæ§‹**ã€**Agent ACL**ã€**Command æ¨¡å¼** å·²å…§å»ºã€‚

### 2. å‰ç«¯ API (`src/services/openclawBoardApi.ts`)
å·²å¯¦ä½œå°æ‡‰å‡½æ•¸ï¼š
- `postCommand()` - å‘¼å« command API
- `postInterrupt()` - å‘¼å« interrupt API  
- `resumeInterrupt()` - å‘¼å« resume API
- `fetchSessionCommands()` - è®€å– session æŒ‡ä»¤æ­·å²
- `fetchSessionInterrupts()` - è®€å–ä¸­æ–·è¨˜éŒ„

### 3. Migration SQL (`docs/supabase-openclaw-migration.sql`)
å·²åŒ…å«æ–°è¡¨æ ¼ï¼š
- `openclaw_sessions` - å”ä½œæœƒè©±/SharedState
- `openclaw_commands` - Command API å¯©è¨ˆ
- `openclaw_interrupts` - Human-in-the-loop è¨˜éŒ„
- `openclaw_runs` - å®Œæ•´åŸ·è¡Œç´€éŒ„

---

## âš ï¸ å¾…å®Œæˆï¼ˆCursor æ¥æ‰‹ï¼‰

### æ­¥é©Ÿ 1ï¼šåŸ·è¡Œ Supabase Migration

**æ–¹æ³• Aï¼šSQL Editorï¼ˆæ¨è–¦ï¼‰**
1. ç™»å…¥ https://supabase.com/dashboard/project/vbejswywswaeyfasnwjq
2. é€²å…¥ SQL Editor â†’ New query
3. è²¼ä¸Š `docs/supabase-openclaw-migration.sql`
4. åŸ·è¡Œ

**æ–¹æ³• Bï¼šç²¾ç°¡ SQLï¼ˆåªå»ºå¿…è¦è¡¨æ ¼ï¼‰**
```sql
CREATE TABLE IF NOT EXISTS public.openclaw_sessions (
  id text PRIMARY KEY,
  shared_state jsonb NOT NULL DEFAULT '{}',
  status text DEFAULT 'active' CHECK (status IN ('active','paused','completed','failed')),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
ALTER TABLE public.openclaw_sessions ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.openclaw_commands (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  session_id text REFERENCES public.openclaw_sessions(id) ON DELETE CASCADE,
  from_agent text NOT NULL,
  command jsonb NOT NULL,
  created_at timestamptz DEFAULT now()
);
ALTER TABLE public.openclaw_commands ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS public.openclaw_interrupts (
  id text PRIMARY KEY,
  session_id text REFERENCES public.openclaw_sessions(id) ON DELETE CASCADE,
  from_agent text NOT NULL,
  reason text NOT NULL,
  decision text CHECK (decision IN ('approve','reject','modify')),
  decided_by text,
  created_at timestamptz DEFAULT now(),
  resolved_at timestamptz
);
ALTER TABLE public.openclaw_interrupts ENABLE ROW LEVEL SECURITY;
```

### æ­¥é©Ÿ 2ï¼šé©—è­‰æ–°ç«¯é»

**æ¸¬è©¦ command APIï¼š**
```bash
curl -X POST http://localhost:3011/api/openclaw/command \
  -H "Content-Type: application/json" \
  -H "x-api-key:REDACTED" \
  -d '{
    "sessionId": "test-001",
    "from": "supervisor",
    "command": {
      "update": {"messages": [{"role":"user","content":"æ¸¬è©¦"}]},
      "goto": "cursor_agent"
    }
  }'

# é æœŸå›æ‡‰ï¼š
# {"ok":true,"next":{"agent":"cursor_agent","task":"...","context":{}}}
```

**æ¸¬è©¦ interrupt APIï¼š**
```bash
curl -X POST http://localhost:3011/api/openclaw/interrupt \
  -H "Content-Type: application/json" \
  -H "x-api-key:REDACTED" \
  -d '{
    "sessionId": "test-001",
    "from": "cursor_agent",
    "reason": "éœ€è¦ç¢ºèªæ˜¯å¦è¦†è“‹æª”æ¡ˆ",
    "options": ["approve", "reject", "modify"],
    "timeoutMinutes": 30
  }'

# é æœŸå›æ‡‰ï¼š
# {"ok":true,"interruptId":"int-xxx","deadline":"...","options":[...]}
```

**æ¸¬è©¦ resume APIï¼š**
```bash
curl -X POST http://localhost:3011/api/openclaw/resume \
  -H "Content-Type: application/json" \
  -H "x-api-key:REDACTED" \
  -d '{
    "sessionId": "test-001",
    "interruptId": "int-xxx",
    "decision": "approve",
    "feedback": "å¯ä»¥åŸ·è¡Œ"
  }'

# é æœŸå›æ‡‰ï¼š
# {"ok":true,"session":{"status":"running","..."}}
```

### æ­¥é©Ÿ 3ï¼šé©—è­‰æ¨™æº–ï¼ˆå¿…é ˆé€šéï¼‰

| æ¸¬è©¦é …ç›® | é æœŸçµæœ |
|---------|---------|
| `command` ä¸å†å› "Cannot POST" | å› `ok: true` ä¸¦æœ‰ `next` æ¬„ä½ |
| `interrupt` å»ºç«‹ä¸­æ–· | å› `interruptId` |
| `resume` æ¢å¾© session | session ç‹€æ…‹è®Šå› running |
| Supabase è³‡æ–™ | å¯çœ‹åˆ° sessions/commands/interrupts è¡¨æ ¼ |

---

## ğŸ“ é—œéµæª”æ¡ˆä½ç½®

```
/Users/caijunchang/openclawä»»å‹™é¢ç‰ˆè¨­è¨ˆ/
â”œâ”€â”€ server/src/index.ts              # å¾Œç«¯ API ä¸»æª”
â”œâ”€â”€ server/src/openclawSupabase.ts   # Supabase æ“ä½œ
â”œâ”€â”€ server/src/openclawMapper.ts     # è³‡æ–™è½‰æ›
â”œâ”€â”€ src/services/openclawBoardApi.ts # å‰ç«¯ API å‡½æ•¸
â”œâ”€â”€ docs/supabase-openclaw-migration.sql  # SQL é·ç§»
â””â”€â”€ docs/AGENT_PROTOCOL.md           # å”è­°è¦æ ¼æ–‡ä»¶
```

---

## ğŸ”§ ç’°å¢ƒè®Šæ•¸

å¾Œç«¯éœ€è¦çš„ `.env` è®Šæ•¸ï¼š
```bash
SUPABASE_URL=https://vbejswywswaeyfasnwjq.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIs...
OPENCLAW_API_KEY=your_api_key
```

---

## â“ å¸¸è¦‹å•é¡Œ

**Q: å¾Œç«¯å•Ÿå‹•å¤±æ•—ï¼Ÿ**  
A: æª¢æŸ¥ port 3011 æ˜¯å¦è¢«ä½”ç”¨ï¼Œæˆ–åŸ·è¡Œ `cd server && npm run build && npm start`

**Q: Supabase é€£ç·šå¤±æ•—ï¼Ÿ**  
A: ç¢ºèª `.env` æœ‰æ­£ç¢ºçš„ `SUPABASE_SERVICE_ROLE_KEY`ï¼ˆä¸æ˜¯ anon keyï¼‰

**Q: API å› 401ï¼Ÿ**  
A: ç¢ºèªè«‹æ±‚å¸¶äº† `x-api-key` headerï¼Œä¸”å€¼æ­£ç¢º

---

**äº¤æ¥äºº**: Codex â†’ **æ¥æ‰‹äºº**: Cursor Agent  
**ç‹€æ…‹**: å¾…åŸ·è¡Œ Migration + é©—è­‰
