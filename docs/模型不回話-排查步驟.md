# 模型不回話 — 排查步驟

當 OpenClaw 2.9 的模型沒有回話時（任務板執行沒輸出、或 Telegram/WhatsApp 沒回覆），依下面順序檢查。

---

## 1. 確認模型與認證狀態（必做）

在終端機執行：

```bash
openclaw models status
openclaw models list
```

- 若出現 **No credentials / No available auth profile**：代表 API key 或 setup-token 沒設好或過期。
- 若 **model 不在 list 裡**：代表設定的 primary 模型 ID 不正確或帳號沒權限。

**修正方向：**

- 用 **API Key**：確保執行 openclaw 的環境有 `ANTHROPIC_API_KEY`。
  - 本機測試：`export ANTHROPIC_API_KEY="sk-ant-..."` 再執行。
  - 常駐 gateway：在 **`~/.openclaw/.env`** 裡加一行 `ANTHROPIC_API_KEY=sk-ant-...`（不要引號、不要空格）。
- 用 **setup-token（訂閱）**：在 gateway 主機執行  
  `openclaw models auth paste-token --provider anthropic`  
  貼上 `claude setup-token` 產生的 token。

---

## 2. 檢查 `~/.openclaw/openclaw.json` 的模型

確認 **primary 模型** 是你帳號有權限的 ID（見 [CLAUDE-MODEL-SETUP.md](./CLAUDE-MODEL-SETUP.md)）：

```bash
# 看目前設定（若已安裝 jq）
cat ~/.openclaw/openclaw.json | jq '.agents.defaults.model'
```

應類似：

```json5
{
  "primary": "anthropic/claude-3-5-sonnet-20241022",
  "fallbacks": ["anthropic/claude-3-haiku-20240307"]
}
```

- 若 `primary` 是舊版或你沒開通的模型（例如 `claude-opus-4-6` 但帳號只有 Sonnet），會造成不回話或 401/403。
- 若 **Default 是 Kimi**（`kimi/kimi-k2.5`）而你想讓 **Claude 先回話**：請把 `primary` 改成 `anthropic/claude-sonnet-4-5-20250929` 或 `anthropic/claude-opus-4-6`（你目前 fallback 已有，Auth 也正常），Kimi 可留在 `fallbacks` 裡。
- 改成你 **`openclaw models list` 或 Anthropic 後台有看到的** 其中一個模型 ID（前綴 `anthropic/`）。

---

## 2.5 Gateway 起不來（Runtime: stopped / Service is loaded but not running）

若狀態顯示 **Gateway not running**、**Service is loaded but not running (likely exited immediately)**，多半是啟動時 **設定驗證失敗** 導致程序馬上退出。

**常見錯誤（看日誌）：**

- `agents.defaults.models.comment: Invalid input: expected object, received string`  
  **原因**：`agents.defaults.models` 底下只能放「model id → 物件」的鍵值，不能放字串（例如註解鍵 `comment`、`comment2`）。  
  **修正**：從 `~/.openclaw/openclaw.json` 的 `agents.defaults.models` 裡刪除任何非 model 的鍵（如 `comment`、`comment2`），只保留 `"provider/model-id": {}` 這種格式。

**日誌位置：**

- 檔案日誌：`/tmp/openclaw/openclaw-YYYY-MM-DD.log`
- LaunchAgent：`~/.openclaw/logs/gateway.log`、`~/.openclaw/logs/gateway.err.log`

**修好後：**

```bash
openclaw doctor --fix
openclaw gateway start    # 手動測試能否常駐
# 若用 LaunchAgent：
launchctl unload ~/Library/LaunchAgents/ai.openclaw.gateway.plist
launchctl load ~/Library/LaunchAgents/ai.openclaw.gateway.plist
```

---

## 3. 本機直接測「模型會不會回話」

在終端機執行（會直接呼叫目前設定的模型）：

```bash
openclaw agent --agent main --local --message "回覆：你好"
```

- **有正常回覆**：代表模型與 key 沒問題，問題可能在任務板或 gateway 的呼叫方式／環境。
- **沒回覆、卡住、或報錯**：把終端機的**完整錯誤訊息**記下來（或貼給協助者），再往下查。

常見錯誤：

- `401` / `invalid api key` → 換新 key 或重新 paste-token。
- `model not allowed` / `404` → 改 `openclaw.json` 的 `primary` 為 list 裡有的模型。
- `timeout` → 網路或 Anthropic 延遲，可加 fallback 或稍後再試。

---

## 3.5 一直出現 `{"error":{"message":"","code":404,"status":"Not Found"}}`

這個 **404 且 message 為空** 的 JSON 通常**不是**任務板後端回傳的（後端 404 會是 `{ "message": "Task not found" }` 等），而是 **呼叫 LLM API 時**（Anthropic / Google Gemini）回傳的。

**可能原因與對應處理：**

| 原因 | 處理方式 |
|------|----------|
| **模型 ID 錯誤或不存在** | 用官方正確 ID：Claude 用 `claude-sonnet-4-5-20250929`、`claude-opus-4-6`；Gemini 用 `gemini-2.5-pro`、`gemini-2.5-flash`，**Gemini 3** 用 `gemini-3-pro-preview`（一定要有 `-preview`）。見 [OPENCLAW-MODELS-REFERENCE.md](./OPENCLAW-MODELS-REFERENCE.md)。 |
| **模型未加入 allowlist** | 在 `~/.openclaw/openclaw.json` 的 `agents.defaults.models` 裡要有對應鍵，例如 `"google/gemini-3-pro-preview": {}`。 |
| **用錯 provider 前綴** | 例如 Kimi 要用 `moonshot/kimi-k2.5` 或 `kimi/kimi-k2.5`，不要寫成 `anthropic/kimi-k2.5`。 |
| **該 API 帳號沒有該模型權限** | 到 Anthropic / Google 後台確認帳號有該模型；或把 primary/fallbacks 改成你有權限的模型。 |

**建議步驟：**

1. 執行 `openclaw models list`，確認你要用的模型在清單裡且名稱一致。
2. 檢查 `agents.defaults.model.primary` 與 `agents.defaults.models` 的鍵是否與 list 一致（含前綴）。
3. 若是 **Gemini 3 Pro**：ID 必須為 `google/gemini-3-pro-preview`，且在 `agents.defaults.models` 有 `"google/gemini-3-pro-preview": {}`。
4. 看 OpenClaw 日誌：`/tmp/openclaw/openclaw-*.log` 或 `~/.openclaw/logs/gateway.err.log`，搜尋 `404` 或 `not_found`，確認是哪個 provider/model 觸發。

---

## 3.6 Gemini 2.5 Flash / 2.5 Pro 對話兩句就掛（process 崩潰）

**現象**：使用 **Google Gemini 2.5 Flash 或 2.5 Pro** 時，對話一兩句後出現：  
- 回覆**重複的內容**，接著就**沒有反應**；或  
- Gateway 崩潰／對話中斷。

**日誌典型錯誤**（見 `~/.openclaw/logs/gateway.err.log`）：  
`TypeError: Cannot read properties of null (reading 'setSession')`  
發生在 `TLSSocket.setSession` / `undici`，即對 **Google API 的 HTTPS 連線** 在連線重用時 TLS 狀態為 null 導致崩潰。

**原因**：Node/undici 對同一 host 的並發或連線重用與 Google API 互動有 bug；切到 Gemini 2.5 Pro 後連續幾次請求容易觸發，導致行程掛掉或 session 壞掉，出現「重複回覆後無反應」。

**建議作法（擇一或搭配）**：

1. **改用 Claude / Kimi 當 primary，Gemini 僅作 fallback**  
   在 `~/.openclaw/openclaw.json` 把 `agents.defaults.model.primary` 設為 `kimi/kimi-k2.5` 或 `anthropic/claude-sonnet-4-5-20250929`，fallbacks 保留 `google/gemini-2.5-flash` 或 `google/gemini-2.5-pro`。多數對話走 primary，只有 fallback 時才打 Gemini，可減少觸發次數。

2. **更新 OpenClaw / Node**  
   ```bash
   npm update -g openclaw
   nvm install-latest-node   # 或升級到 Node 22 LTS 最新
   ```
   再重啟 Gateway：`openclaw gateway restart`。

3. **缺檔時補上**  
   若日誌有 `ENOENT: ... config/gemini.env`，可建立空檔或與 google 共用：
   ```bash
   echo 'GOOGLE_API_KEY=你的key' > ~/.openclaw/config/gemini.env
   # 或已有 google.env 時：ln -sf google.env ~/.openclaw/config/gemini.env
   ```

4. **回報給 OpenClaw**  
   若持續發生，可到 OpenClaw 官方 repo/issue 附上上述錯誤與 Node 版本、openclaw 版本，方便上游修 undici/TLS 行為。

**若接著出現「400 status code (no body)」**：多半是崩潰後 session/連線異常，再打 Telegram 或其它 API 時被回 400；先 `openclaw gateway restart`、改回 Kimi/Claude，詳見 `docs/Gemini-2.5-Pro-重複回覆後無反應-排查.md` 文末。

---

## 4. 任務板執行沒輸出時

任務板是執行：

```bash
timeout 60 openclaw agent --agent main --local --message "任務名稱與描述"
```

- 若 **本機手動執行上面指令有回覆**，但任務板沒有：
  - 確認跑任務板 server 的**同一個使用者、同一個環境**是否有設 `ANTHROPIC_API_KEY`（例如用 systemd/launchd 時，要在那個服務的環境裡設好）。
  - 看任務板後端 log（例如 `server` 的 console 或 Railway log）有沒有 timeout、stderr 錯誤。
- 若 **本機手動執行也沒回覆**：先依上面 1～3 步修好模型與 key，再測任務板。

---

## 5. Telegram / WhatsApp 沒回覆時

- 先確認 **gateway 有在跑**：  
  `openclaw gateway run` 或你平常啟動的方式，同一個 process 要能載到 `~/.openclaw/.env` 和 `openclaw.json`。
- 再確認 **同一個 gateway 環境**底下 `openclaw models status` 是 OK 的（若在別的 shell 設了 key，gateway 那隻 process 不會用到）。
- 看 **gateway 的 log**（終端輸出或 `logging.file` 路徑）：是否有 401、model not allowed、或連線錯誤。

---

## 6. 404 但 Anthropic 直接測試正常時：檢查「當前對話用哪個模型」

若用 curl 或 `openclaw agent --local` 打 **Anthropic** 正常，但 Telegram 同一個 bot 還是 404，多半是 **該對話的 session 記住了別的模型**（例如 Google Gemini）。

- 看 session 用的模型：`~/.openclaw/agents/main/sessions/sessions.json` 裡對應 session 的 `modelOverride` / `providerOverride`。
- 若寫的是 **google**（例如 `gemini-2.5-pro`），但沒在 `~/.openclaw/.env` 設 `GOOGLE_GENERATIVE_AI_API_KEY`（或專案要求的 Google 變數名），就會 404。

**解法二選一：**

1. **改用 Kimi / Claude**：在 Telegram 對 bot 發送 **`/model`**，選 **kimi** 或 **anthropic** 的模型，該對話之後就會用選定的模型，不再用 Google。
2. **繼續用 Gemini**：在 **`~/.openclaw/.env`** 加上 Google API key（變數名依 OpenClaw 說明，常見為 `GOOGLE_GENERATIVE_AI_API_KEY` 或 `GEMINI_API_KEY`），存檔後重啟 gateway。

---

## 7. 快速檢查清單

| 項目 | 指令或位置 |
|------|------------|
| 模型與認證 | `openclaw models status`、`openclaw models list` |
| API Key 位置 | `~/.openclaw/.env` 的 `ANTHROPIC_API_KEY`（gateway 與本機測試都要能讀到） |
| 使用的模型 ID | `~/.openclaw/openclaw.json` → `agents.defaults.model.primary` |
| 本機測試回話 | `openclaw agent --agent main --local --message "你好"` |
| 健康檢查 | `openclaw doctor`（可選） |

多數「模型不回話」是 **key 沒設對** 或 **primary 模型 ID 與帳號權限不符**，先完成 1、2、3 步通常能定位問題。

---

## 8. 主要 bot 沒問題，404 時「向上排查」順序

**結論**：主要 bot（@xiaoji_cai_bot）與 Telegram 設定（token、channels.telegram）目前**沒有問題**。404 是 **「這個對話用的是哪個模型 → 該模型的 API 是否可用」** 造成的，不是 bot 壞掉。

**一出現 404，建議照下面順序往上查（從使用者現象往回推）：**

| 步驟 | 查什麼 | 怎麼查 | 若發現問題 |
|------|--------|--------|------------|
| 1 | 這個對話實際用的是哪個模型？ | 開 `~/.openclaw/agents/main/sessions/sessions.json`，找對應 session（例如 Telegram 私聊的 `agent:main:main`），看 **modelOverride**、**providerOverride** | 記下 provider（如 google、anthropic、kimi） |
| 2 | 該 provider 的 API key 有沒有設、有沒有效？ | 看 `~/.openclaw/.env` 或 `openclaw.json` 裡該 provider 的 apiKey / 環境變數 | **Google**：補 `GOOGLE_GENERATIVE_AI_API_KEY` 或改用 `/model` 切到 kimi/Claude<br>**Anthropic**：補/更新 `ANTHROPIC_API_KEY`<br>**Kimi**：確認 openclaw.json 或 .env 的 key 有效 |
| 3 | 該模型 ID 在 API 是否還支援？ | 查官方文件或 `openclaw models list` | 把 primary/fallbacks 或 allowlist 改成目前支援的 model id |
| 4 | Gateway 有沒有重啟、有沒有載到新 key？ | 改過 .env 或 openclaw.json 後執行 `openclaw gateway restart` | 重啟後再試一次 |

**最常見**：該對話被設成 **Google（Gemini）** 但沒設 Google key → 在 Telegram 對 bot 發 **`/model`** 選 **kimi** 或 **anthropic** 即可，不必動 bot 或 Telegram 設定。

**若用 LaunchAgent 跑 gateway**：launchd 的 plist **不會**自動載入 `~/.openclaw/.env`，所以 `openclaw.json` 裡的 `${ANTHROPIC_API_KEY}`、`${KIMI_API_KEY}` 等可能變成空字串。解法：把**有效的** API key 直接寫在 `openclaw.json` 對應 provider 的 `apiKey` 欄位，或改為在終端機用 `openclaw gateway` 手動跑（會載入當前 shell 的環境）。

**若 404 且錯誤為 not_found_error**：Anthropic API 只接受**不含前綴**的 model id（例如 `claude-opus-4-5-20251101`）。設定裡用 `anthropic/claude-opus-4-5-20251101` 是給 OpenClaw 路由用的；實際打 API 時應只送 `claude-opus-4-5-20251101`。若 OpenClaw 某段程式把整串 `anthropic/...` 送給 API，就會 404。請確認 `openclaw.json` 裡 `models.providers.anthropic.models[].id` 都是無前綴的（你目前是）；若仍 404，可能是該版 OpenClaw 的 bug，可升級或向官方回報。

**關於「內部名稱 → API 真實 ID」映射**：有些文件會寫成 `models: { "claude-opus-4-5-20251101": "claude-3-opus-20240229" }` 這種 key→value 對應。目前 OpenClaw 2026.2.9 的 schema 是 `models` 為**陣列**（每項有 `id`、`name`、`api` 等），且 `id` 就是送給 Anthropic 的 model id；我們用的 `claude-opus-4-5-20251101`、`claude-sonnet-4-5-20250929` 等已是 API 有效 id，不需再映射到舊版 id。另，`agents.defaults.models` 在現行版本必須是**物件**（record），不能是陣列，否則會報「expected record, received array」。
