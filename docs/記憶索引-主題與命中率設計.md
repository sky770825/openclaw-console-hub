# 記憶索引 — 主題與命中率設計

> **概念：** 用「當前主題」提高常用內容的命中機率；用「未命中次數」決定何時調整索引，讓索引跟著實際對話集中度走。

---

## 一、為什麼要做主題與命中率？

- **話題通常集中：** 多數對話會圍繞一兩個主題（例如這週在搞 Ollama Fallback、任務板），其他記憶區塊用到的機率低。
- **未命中浪費：** 索引裡若一直沒被觸發的關鍵字，等於白佔說明、又可能讓 Agent 多查無關內容。
- **可調比例：** 讓「當前主題」相關內容被命中的機率較高（例如固定帶入一句摘要，或優先查該區塊），其餘按需再查。
- **比例分配：** 在 3／5／10 次處理的視窗內呈現比例；若某主題已佔 70～80%，其他比例很低或為 0 的區塊就不重複引入或處理。具體實作見 **docs/記憶索引-比例分配與實作流程.md**。

---

## 二、當前主題（提升命中機率）

### 做法

1. **MEMORY_TOPIC.md**（workspace 根目錄）
   - 欄位：**當前主題**（名稱）、**一句摘要**（可選，約 1～2 句）。
   - 若對話**連續多輪**都圍繞同一件事，就更新此檔：寫入該主題名稱與一句摘要。
   - 效果：該主題相關的關鍵字可視為**高優先**——Agent 可優先對這些關鍵字做 memory_search，或若把「一句摘要」放進 bootstrap，該主題就等於**每次都被帶入**（命中率 100%），但會多一點 token。

2. **比例／權重**
   - **不額外載入**：只把「當前主題」寫在 MEMORY_TOPIC.md，Agent 每輪讀到後，對「當前主題關鍵字」優先查 MEMORY_FULL；其他關鍵字照常。→ 不增加 bootstrap token，只改變查詢優先順序。
   - **可選：固定帶入摘要**：若希望該主題「幾乎一定命中」，可把 MEMORY_TOPIC.md 加入 bootstrap，或把其中「一句摘要」寫進 MEMORY.md 最上方（約 1～2 句）。→ 多一點 token，換該主題高命中。

3. **何時更新當前主題**
   - 連續 2～3 輪以上都在聊同一件事（例如修 Fallback Bot、任務板 API）→ 將該主題寫入 MEMORY_TOPIC.md，並可補一句摘要。
   - 話題明顯切換（例如從技術改聊行程）→ 更新為新主題或清空。

---

## 三、未命中次數 → 調整索引

### 原則

- **有命中才值得留：** 若某個關鍵字或某個記憶區塊**連續 N 輪都沒被觸發**（例如 3 輪），代表近期對話用不到，可以：
  - **選項 A：** 從 MEMORY.md 索引暫時移除或合併到其他關鍵字，減少干擾。
  - **選項 B：** 保留關鍵字，但標記為「低優先」；若之後又出現再調高。
- **不要一次刪太多：** 建議以「很少用到的區塊」為主，且記憶庫（MEMORY_FULL）裡的內容可保留，只調整「是否出現在索引」與優先級。

### 實作方式（可選）

- **index_state**（例如 `memory/index_state.json`）  
  - 欄位建議：`current_topic`、`topic_summary`、`last_updated`、`miss_count`（或 `last_hit_turn`  per 區塊）。
  - 規則範例：每輪結束後，若某區塊本輪未命中則 `miss_count += 1`，若命中則歸零；當 `miss_count >= 3`，在回覆或日誌中**建議**「可考慮將 OOO 從索引移除或合併」。
  - 實際是否移除仍由人或有權限的流程決定，Agent 只負責記錄與建議。

若暫時不做 index_state，也可以**手動或每週檢視**：看最近對話都圍繞哪些關鍵字、哪些從來沒出現，再手動精簡 MEMORY.md 索引。

---

## 四、話題集中時的建議用法

- **大部分是同一主題的衍生：**
  - 當前主題寫進 MEMORY_TOPIC.md，並可視需要給 1～2 句摘要（要不要進 bootstrap 自訂）。
  - 索引（MEMORY.md）維持「只列記憶庫有對應內容」；其他區塊不刪也可，但查詢時以「當前主題」相關關鍵字為優先。
  - 若某區塊連續多輪未命中，再依上節調整索引或標記低優先。

- **這樣做的好處：**
  - 常用內容（當前主題）命中機率高，甚至可固定帶入少量摘要。
  - 少用或沒用到的索引可逐步收斂，避免無效關鍵字佔據注意力與 token。

---

## 五、對照表

| 情境 | 建議動作 |
|------|----------|
| 連續 2～3 輪同一話題 | 更新 MEMORY_TOPIC.md（當前主題 + 可選一句摘要） |
| 希望該主題幾乎必中 | 可選：將 MEMORY_TOPIC 或一句摘要加入 bootstrap / MEMORY.md 頂部 |
| 某關鍵字／區塊連續 3 輪未命中 | 建議檢視：從 MEMORY.md 移除或合併，或標記低優先 |
| 話題明顯切換 | 更新或清空 MEMORY_TOPIC.md |
| 每週或定期 | 檢視 index_state 或對話紀錄，精簡索引、對齊記憶庫 |
| 比例分配（3／5／10 輪） | 見 **記憶索引-比例分配與實作流程.md**：視窗內比例 ≥ 70% 為主導，本輪只載入主導 + 有匹配的區塊，不重複引入低比例區塊 |

---

_實作時：MEMORY_TOPIC.md 與 index_state 均為可選；先從「當前主題 + 手動精簡索引」開始，再視需要加上比例分配與自動建議。_
