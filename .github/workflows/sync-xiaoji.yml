name: Sync to 小蔡 Repo

on:
  push:
    branches: [main]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH for xiaoji repo
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.XIAOJI_DEPLOY_KEY }}" > ~/.ssh/xiaoji_key
          chmod 600 ~/.ssh/xiaoji_key
          cat >> ~/.ssh/config <<SSHEOF
          Host xiaoji-github
            HostName github.com
            User git
            IdentityFile ~/.ssh/xiaoji_key
            StrictHostKeyChecking no
          SSHEOF

      - name: Push to xiaoji repo
        run: |
          git remote add xiaoji git@xiaoji-github:andy825lay-tech/openclaw-workspace.git || true
          # 先嘗試正常 push；若 workflow scope 被拒，改用過濾方式
          if ! git push xiaoji main --force 2>&1; then
            echo "Direct push failed, filtering .github/workflows and retrying..."
            # 建立臨時分支，移除 workflow 檔案後推送
            git checkout -b sync-temp
            git rm -r --cached .github/workflows/ 2>/dev/null || true
            git commit -m "sync: exclude workflows for xiaoji push" --allow-empty
            git push xiaoji sync-temp:main --force
            git checkout main
            git branch -D sync-temp
          fi

      - name: Notify Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COMMIT_MSG=$(git log -1 --pretty=%s)
          COMMIT_SHA=$(git log -1 --pretty=%h)
          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
            TEXT="已同步到小蔡 repo"
          else
            EMOJI="❌"
            TEXT="同步失敗"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode=Markdown \
            -d text="${EMOJI} *Git Sync* | ${TEXT}
          \`${COMMIT_SHA}\` ${COMMIT_MSG}"
