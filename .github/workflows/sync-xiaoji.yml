name: Sync to 小蔡 Repo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH for xiaoji repo
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.XIAOJI_DEPLOY_KEY }}" > ~/.ssh/xiaoji_key
          chmod 600 ~/.ssh/xiaoji_key
          cat >> ~/.ssh/config <<SSHEOF
          Host xiaoji-github
            HostName github.com
            User git
            IdentityFile ~/.ssh/xiaoji_key
            StrictHostKeyChecking no
          SSHEOF

      - name: Push to xiaoji repo (exclude workflows)
        run: |
          git checkout -b sync-temp
          git rm -r --cached .github/workflows/ 2>/dev/null || true
          git commit -m "sync: mirror from openclaw-console-hub @ $(git log main -1 --pretty=%h)" --allow-empty
          git remote add xiaoji git@xiaoji-github:andy825lay-tech/openclaw-workspace.git || true
          git push xiaoji sync-temp:main --force
          git checkout main
          git branch -D sync-temp

      - name: Notify Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COMMIT_MSG=$(git log -1 --pretty=%s)
          COMMIT_SHA=$(git log -1 --pretty=%h)
          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
            TEXT="已同步到小蔡 repo"
          else
            EMOJI="❌"
            TEXT="同步失敗"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode=Markdown \
            -d text="${EMOJI} *Git Sync* | ${TEXT}
          \`${COMMIT_SHA}\` ${COMMIT_MSG}"
